---
title: "Atmospheric Conductance Sensitivity Analysis"
author: "Elmera Azadpour, Danielle Sciafani, Desik Somasundaram"
date: '2022-04-21'
output:
  html_document: default
  pdf_document: default
---

## Setup
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(here)
library(tidyverse)
library(pse)
```

```{r}
source(here("functions","atmospheric_conductance.R"))
```

## Analysis
```{r}
#test function
atmos_conduct(1000, 250)
```

```{r}
# 4 parameters for sensitivity analysis
factors = c("h", "k_d", "k_0", "v")

# Decide How many parameter sets to run
nsets=100
# distributions for parameters along with known ranges for sampling
q = c("qunif","qnorm", "qnorm", "qnorm")
q.arg = list(list(min=950, max=1050),list(mean=0.7,sd=0.007), list(mean=0.1, sd=0.001), list(mean=250,sd=30))

# generate samples from LHS
sens_atmos_cond = LHS(NULL,factors,nsets,q,q.arg)
sens_pars = get.data(sens_atmos_cond)
head(sens_pars)
```

```{r}
# run model for all of the parameters generated by LHS
# use map function that uses the actual names of input parameters

atmospheric_conductance = sens_pars %>% pmap(atmos_conduct)
head(atmospheric_conductance)
```

## Results and Visualizations
```{r}
# turn results in to a dataframe for easy display/analysis
atmospheric_conductancedf = atmospheric_conductance %>% map_dfr(`[`,c("atmospheric_conductance"))

# tell links output to original LHS object once results are in matrix
sens_atmos_cond = pse::tell(sens_atmos_cond, t(as.matrix(atmospheric_conductancedf)),
                        res.names=c("atmospheric_conductance"))
```

```{r}
# add uncertainty bounds on our estimates (c)
tmp = atmospheric_conductancedf %>%
  mutate(type = "atmospheric_conductance") %>% 
  rename(value = atmospheric_conductance)
  
ggplot(tmp, aes(atmospheric_conductance, value))+
  geom_boxplot()+
  labs(y="Atmospheric Conductance (cm/s)") +
  theme_classic()
```

```{r}
#use built in LHS functions to analyze parameter sensitivity (d)
pse::plotscatter(sens_atmos_cond, col="blue", cex=5) 
```


```{r}
# Estimate the Partial Rank Correlation Coefficients (e)
# PSE: object has partial rank correlation coefficients

# prcc's automatically generated and easy to plot
pse::plotprcc(sens_atmos_cond)
# more negative/more positive the value, the more sensitive your object is to 

# PRCC for all 3 output metrics
sens_atmos_cond$res.names
sens_atmos_cond$prcc

# correlation coefficient
# compare PRCC with first correlation coefficient
# recall
head(atmospheric_conductancedf)
sens_atmos_cond$prcc[1]

# we can still use our sens_pars data frame - rows of parameters will be
# match rows in the output from our use of pmap to run the model for all 
# parameters
cor(atmospheric_conductancedf$atmospheric_conductance, sens_pars$h, method="spearman")
cor(atmospheric_conductancedf$atmospheric_conductance, sens_pars$k_d, method="spearman")
cor(atmospheric_conductancedf$atmospheric_conductance, sens_pars$k_0, method="spearman")
cor(atmospheric_conductancedf$atmospheric_conductance, sens_pars$v, method="spearman")
```

## Discussion
***Discuss what your results tell you about how aerodynamic conductance varies with the different parameters? What does it suggest about what you should focus on if you want to reduce uncertainty in aerodynamic conductance estimates? Does this tell you anything about the sensitivity of plant water use to climate change? (f) ***

Our results indicate that atmospheric conductance is most sensitive to v which is wind speed, followed by k_d, k_0, and h (vegetation height). This means that getting more precise wind speed would help significantly reduce the uncertainty in aerodynamic conductance estimates. Climate change is expected to have a significant impact on weather patterns around the world with an expected decrease in mean wind speed in most regions. However, it is important to note that the changes will depend locally so it's hard to generalize without setting a more specific region of interest. Another factor to consider is the rise in stomatal conductance due to global rise in temperature which also affects plant water use. 

